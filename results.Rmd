# Results

```{r}
library(tidyverse)
library(ggthemes)
library(parcoords)
load("data/travel_data.rda")  # df_travel
load("data/mobility_general.rda")  # df_general
weight <- read.csv("data/weight_fill.csv")
```

```{r, echo=FALSE}
# Define a function to set the theme of plots
theme_user <- function(total_size, title_size, subtitle_size, angle) {
  theme_plot <- theme_bw(total_size) +
  theme(axis.text.x = element_text(size = rel(0.8), angle = angle, vjust = 0.5),
        axis.text.y = element_text(size = rel(0.8)), 
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(size = rel(0.7)),
        axis.title.y = element_text(size = rel(0.7)),
        panel.grid.major.x = element_line(size = 0.8),
        panel.grid.major.y = element_line(size = 0.8),
        panel.grid.minor.x = element_blank(),
        plot.title = element_text(size = title_size), 
        plot.subtitle = element_text(color = "gray30", size = subtitle_size),
        plot.caption = element_text(size = rel(0.5)),
        legend.title = element_blank(),
        legend.text = element_text(size = 10),
        legend.key.size = unit(0.6, "cm"),
        panel.spacing = unit(3, 'pt'))
  return <- theme_plot
}
```



## Is there any differences between the gender composition of the residents choosing different transportation modes?

Calculate the proportion of the respondents with different gender. There are totally 41.12% males and 58.77% females among all the respondents.

```{r}
traveler_gender <- df_general[c(1:2, 31)]

traveler_gender['gender'] <- factor(traveler_gender$qgender)

traveler_gender %>%
  group_by(gender) %>%
  summarise(num = sum(allwt)) %>%
  ungroup() %>%
  mutate(prop = num / sum(num)) %>% 
  ggplot(aes(reorder(gender, -prop), prop)) +
  geom_col() +
  labs(x = 'Gender', y = 'Count', title = "Propotion of Male and Female Respondents", 
       caption = "Source: https://data.cityofnewyork.us/Transportation/Citywide-Mobility-Survey-Main-Survey/dd6w-hnq9") +
  theme_wsj() +
  scale_x_discrete(labels=c("1" = "Male", "2" = "Female", "3" = "Don't know", "4" = "Refused")) +
  theme_user(15, 14, 12, 0)
```

After removing the records which are "Don't know" or "Refused" in Gender, we plot a stacked bar chart and use the proportion of each gender we calculated above as the basis for comparison. Note that if there's no difference between the gender composition of each transportation mode, then the line separates male and female should be on the same level. 

We can easily notice that the gender composition among different modes are different, expecially between bicycle and the other modes. Almost 70% residents that prefer riding a bicyle to get around the city are males, greatly beyond the number of females. On the contrary, relative less males than females would like to choose bus, for-hire vehicle and walk, which is not due to the unbalanced sampling proportion of different gender.

In order to interpret the huge difference between the number of males and females prefering bicycle, we propose several possible reasons firstly. It may be because females do not think riding bicycle is safe enough in New York City due to the high crime rate, or males want to make use of their spare time to take exercise, for which riding bicycle is a good idea. We can further verify our guesses by exploring the question in the questionaire, "Which of the following words most apply to Bicycling?".   

```{r, echo=FALSE}
# Transportation mode ~ Gender
traveler_gender1 <- traveler_gender[c(1, 4)] %>%
  filter(gender %in% c(1, 2))
travel_mode <- df_travel[c(1, 5:12)]

df1 <- merge(travel_mode, traveler_gender1, by = "UniqueID", all.y = TRUE) %>%
  gather(key = 'Mode', value = "Number", -c(1, 10)) %>%
  merge(weight, by = "UniqueID", all = TRUE) %>%
  mutate(Count = weight_fill * Number) %>%
  group_by(Mode, gender) %>%
  summarise(Sum = sum(Count)) %>%
  ungroup() %>%
  group_by(Mode) %>%
  mutate(Prop = Sum/sum(Sum), Order = last(Prop)) %>%
  ungroup()

ggplot(df1, aes(reorder(Mode, -Order), Sum, fill = gender)) +
  geom_bar(stat="identity", position = "fill") + 
  labs(x = 'Transportation Mode', y = 'Proportion', title = "Gender Composition",
       caption = "Source: https://data.cityofnewyork.us/Transportation/Citywide-Mobility-Survey-Main-Survey/dd6w-hnq9") +
  theme_wsj() +
  scale_fill_brewer(palette = "Set2", name = "Gender", labels = c("Male", "Female")) +
  theme_user(15, 14, 12, 45)
```

Visualize respondents' description of bicycling via Cleverland dot plot faceted by gender. We separate respondents into two groups, prefering bicycling and not prefering bicycling. For those would like to ride a bicycle to get around the city, both females and males, the majority of them think bicycling is not only inexpensive but also convenient. However, for those not prefering bicycling, the main reason for they rejecting to ride a bicycling to get around the city is that they think it's not safe enough in New York City. By further exploring, we notice that the order of the reasons for prefering or not prefering riding a bicycle are the same for male and female residents, but the gender composition in Bicycling shows that more males than females chose this mode. The possible interpretation is that what males are concerned about most is different from that of females. Comparing safety with cost as well as comfort level, males value the latter more. On the contrary, females may be concerned about safety most, which is consistent with our guess.

```{r}
survey <- read.csv("data/raw_survey_data.csv")

Survey <- survey %>%
  filter(!is.na(qgender) & qgender %in% c(1, 2)) %>%
  subset(select = c("UniqueID", "qgender", "gFOCUSAA1_qFOCUSAA6_mA1", "gFOCUSAA1_qFOCUSAA6_mA2", 
                    "gFOCUSAA1_qFOCUSAA6_mA3", "gFOCUSAA1_qFOCUSAA6_mA4",
                    "gFOCUSAA1_qFOCUSAA6_mA5", "gFOCUSAA1_qFOCUSAA6_mA6",
                    "gFOCUSAA1_qFOCUSAA6_mA7", "gFOCUSAA1_qFOCUSAA6_mA8", "allwt"))

colnames(Survey) <- c("UniqueID", "Gender", "Convenient", "Reliable", 
                      "Fast", "Inexpensive", "Safe", "Comfortable","Don't know", "Refused", "allwt")

Survey$Gender[Survey$Gender == '1'] <- "Male"
Survey$Gender[Survey$Gender == '2'] <- "Female"

survey_1 <- merge(travel_mode, Survey, by = "UniqueID", all.y = TRUE) %>%
  filter(Bicycle == 0) %>%  # Only forcus on those did not choose bicycle
  subset(select = c(1, 10:19)) %>%
  gather(key = "Description", value = "Choice", -c(1:2, 11)) %>%
  group_by(Description, Gender, Choice) %>%
  summarise(Num = sum(allwt)) %>%
  ungroup() %>%
  group_by(Description, Gender) %>%
  mutate(Prop = Num / sum(Num), Order = first(Prop)) %>%
  ungroup()
  
# Description of Bicycling from Residents Who Do Not Prefer Bicycling
ggplot(survey_1, aes(x = Prop, y = reorder(Description, -Order), color = factor(Choice))) +
  geom_point(size = 1.8) +
  facet_grid(Gender~.) +
  labs(x = "Proportion", y = "Description", title = "Description of Bicycling from Residents Who Do Not Prefer Bicycling",
       caption = "Source: Source: https://data.cityofnewyork.us/Transportation/Citywide-Mobility-Survey-Main-Survey/dd6w-hnq9", 
       x = "Count", y = "Modes of Transportation") + 
  scale_color_manual(labels = c("No", "Yes"), values = c("cyan2", "sienna3"))+
  theme_user(15, 14, 12, 0)


survey_2 <- merge(travel_mode, Survey, by = "UniqueID", all.y = TRUE) %>%
  filter(Bicycle == 1) %>%  # Only forcus on those did not choose bicycle
  subset(select = c(1, 10:19)) %>%
  gather(key = "Description", value = "Choice", -c(1:2, 11)) %>%
  group_by(Description, Gender, Choice) %>%
  summarise(Num = sum(allwt)) %>%
  ungroup() %>%
  group_by(Description, Gender) %>%
  mutate(Prop = Num / sum(Num), Order = first(Prop)) %>%
  ungroup()

# Description of Bicycling from Residents Who Prefer Bicycling
ggplot(survey_2, aes(x = Prop, y = reorder(Description, -Order), color = factor(Choice))) +
  geom_point(size = 1.8) +
  facet_grid(Gender~.) +
  labs(x = "Proportion", y = "Description", title = "Description of Bicycling from Residents Who Prefer Bicycling",
       caption = "Source: Source: https://data.cityofnewyork.us/Transportation/Citywide-Mobility-Survey-Main-Survey/dd6w-hnq9", 
       x = "Count", y = "Modes of Transportation") + 
  scale_color_manual(labels = c("No", "Yes"), values = c("cyan2", "sienna3"))+
  theme_user(15, 14, 12, 0)
```


## Is there any differences between the income composition of the residents choosing different transportation modes?

We are also interested in the possible relationship between resident's income and their mode choices. First we plot a bar chart in terms of income to quick learn about the proportion of respondents with different income. According to our interest, we recombine the income into 4 categories, which are "\$100,000 and above", "\$25,000 - \$99,999", "Less than \$24,999" and "Other". Almost half of the respondents have a year's income between $25,000 and \$99,999 and the proportions of residents with less than \$24,999 in come and those with more than \$100,000 income are roughly equal.

```{r}
traveler_income <- df_general[c(1, 6, 31)]
traveler_income$qincome[traveler_income$qincome %in% c(1, 2)] <- "Less than $24,999"
traveler_income$qincome[traveler_income$qincome %in% c(3, 4, 5, 6)] <- "$25,000 - $99,999"
traveler_income$qincome[traveler_income$qincome %in% c(7, 8, 9)] <- "$100,000 and above"
traveler_income$qincome[traveler_income$qincome %in% c(10, 11)] <- "Other"

traveler_income['qincome'] <- factor(traveler_income$qincome, 
                                     levels = c("$100,000 and above", 
                                                "$25,000 - $99,999", 
                                                "Less than $24,999", 
                                                "Other"))

traveler_income %>%
  group_by(qincome) %>%
  summarise(num = sum(allwt)) %>%
  ungroup() %>%
  mutate(prop = num / sum(num)) %>% 
  ggplot(aes(qincome, prop)) +
  geom_col() +
  labs(x = 'Income', y = 'Proportion', title = "Propotion of Respondents with Different Income", 
       caption = "Source: https://data.cityofnewyork.us/Transportation/Citywide-Mobility-Survey-Main-Survey/dd6w-hnq9") +
  theme_wsj() +
  theme_user(15, 14, 12, 0)
```

Then we plot a stacked bar chart to compare the income composition between different modes. The most obvious differences include 1) the residents whose income higher than \$100,000 prefer bicycling and car more than other thansportation modes and the proportions of these two choices are roughly equal, 2) compared with other modes, the residents choosing walking and taking bus or subway are composed by more people with lower than \$24,999 income. Also, the respondents whose income are between \$25,000 and \$99,999 take a large proportion in those loving train and rail. 

```{r}
# Transportation mode ~ Income
traveler_income <- df_general[c(1, 6)] 
income <- merge(travel_mode, traveler_income, by = "UniqueID", all.y = TRUE) %>%
  gather(key = 'Mode', value = "Number", -c(1, 10)) %>%
  merge(weight, by = "UniqueID", all.y = TRUE) %>%
  mutate(Count = weight_fill * Number) 

income$qincome[income$qincome %in% c(1, 2)] <- "Less than $24,999"
income$qincome[income$qincome %in% c(3, 4, 5, 6)] <- "$25,000 - $99,999"
income$qincome[income$qincome %in% c(7, 8, 9)] <- "$100,000 and above"
income$qincome[income$qincome %in% c(10, 11)] <- "Other"

income['qincome'] <- factor(income$qincome, 
                        levels = c("Other", "Less than $24,999", "$25,000 - $99,999", "$100,000 and above"))

income <- income %>%
  group_by(Mode, qincome) %>%
  summarise(Sum = sum(Count)) %>%
  ungroup() %>%
  group_by(Mode) %>%
  mutate(Prop = Sum/sum(Sum), Order = last(Prop)) %>%
  ungroup()

ggplot(income, aes(reorder(Mode, -Order), Sum, fill = qincome)) +
  geom_bar(stat="identity", position = "fill") + 
  labs(x = 'Transportation Mode', y = 'Proportion', title = "Income Composition",
       caption = "Source: https://data.cityofnewyork.us/Transportation/Citywide-Mobility-Survey-Main-Survey/dd6w-hnq9") +
  theme_wsj() +
  scale_fill_brewer(palette = "Set2") +
  theme_user(16, 16, 12, 45)
```

The common advantage of walking, taking bus and taking subway that people think should be their inexpensiveness and convenience, which can be verified by the following plot. According to this, that people whose year's income are below $24,999 prefer walking, taking bus and subway can be understood. 

```{r}
walk <- survey %>%
  filter(!is.na(qgender)) %>%
  subset(select = c("UniqueID", "gFOCUSAA1_qFOCUSAA1_mA1", "gFOCUSAA1_qFOCUSAA1_mA2", 
                    "gFOCUSAA1_qFOCUSAA1_mA3", "gFOCUSAA1_qFOCUSAA1_mA4",
                    "gFOCUSAA1_qFOCUSAA1_mA5", "gFOCUSAA1_qFOCUSAA1_mA6", "allwt"))

subway <- survey %>%
  filter(!is.na(qgender)) %>%
  subset(select = c("UniqueID", "gFOCUSAA1_qFOCUSAA2_mA1", "gFOCUSAA1_qFOCUSAA2_mA2", 
                    "gFOCUSAA1_qFOCUSAA2_mA3", "gFOCUSAA1_qFOCUSAA2_mA4",
                    "gFOCUSAA1_qFOCUSAA2_mA5", "gFOCUSAA1_qFOCUSAA2_mA6", "allwt"))

bus <- survey %>%
  filter(!is.na(qgender)) %>%
  subset(select = c("UniqueID", "gFOCUSAA1_qFOCUSAA3_mA1", "gFOCUSAA1_qFOCUSAA3_mA2", 
                    "gFOCUSAA1_qFOCUSAA3_mA3", "gFOCUSAA1_qFOCUSAA3_mA4",
                    "gFOCUSAA1_qFOCUSAA3_mA5", "gFOCUSAA1_qFOCUSAA3_mA6", "allwt"))

colnames(walk) <- c("UniqueID", "Convenient", "Reliable", 
                      "Fast", "Inexpensive", "Safe", "Comfortable", "allwt")
colnames(subway) <- c("UniqueID", "Convenient", "Reliable", 
                      "Fast", "Inexpensive", "Safe", "Comfortable", "allwt")
colnames(bus) <- c("UniqueID", "Convenient", "Reliable", 
                      "Fast", "Inexpensive", "Safe", "Comfortable", "allwt")

walk <- walk %>%
  gather(key = "Description", value = "Answer", -c(1, 8)) %>%
  mutate(Mode = "Walk")

subway <- subway %>%
  gather(key = "Description", value = "Answer", -c(1, 8)) %>%
  mutate(Mode = "subway")

bus <- bus %>%
  gather(key = "Description", value = "Answer", -c(1, 8)) %>%
  mutate(Mode = "Bus")

describe <- rbind(walk, subway, bus) %>%
  group_by(Mode, Description, Answer) %>%
  summarise(Sum = sum(allwt)) %>%
  ungroup() %>%
  group_by(Mode, Description) %>%
  mutate(Prop = Sum/sum(Sum), Order = last(Prop)) %>%
  ungroup()

describe$Answer[describe$Answer == 0] <- "No"
describe$Answer[describe$Answer == 1] <- "Yes"

describe$Answer <- factor(describe$Answer, levels = c("Yes", "No"))
describe$Description <- factor(describe$Description, levels = c("Inexpensive", "Convenient", "Reliable", "Safe", "Comfortable", "Fast"))

ggplot(describe) +
  geom_mosaic(aes(x = product(Answer, Description), fill = Answer, weight = Sum)) + 
  facet_grid(.~Mode) +
  labs(x = 'Description', y = 'Answer', title = "Descriptions of Bus, Subway and Walk",
       caption = "Source: https://data.cityofnewyork.us/Transportation/Citywide-Mobility-Survey-Main-Survey/dd6w-hnq9") +
  scale_fill_brewer(palette = "Set2") +
  theme_wsj() +
  theme_user(16, 16, 12, 45) + 
  theme(legend.position = "none")
```

Now let's back to the graph "Income Composition" and think about train and rail. There seems some difference between the proportion of people having different income. But actually we don't think it's caused by the difference between people's income directly. We suspect that it's due to the lack of subway in the region whese these residents live. Because when we are asked to choose a transportation mode, if subway and train are available meanwhile, most of us would choose subway due to its fast speed and inexpensiveness. 

Let's verify this guess by plotting a bar chart of the borough distribution of the residents who prefer train and rail, and compare it with the map of New York City subway system. We also plot the borough distribution of all the residents to determine whether or not the pattern we would found is caused by the ubanlanced sampling proportion of different borough.

The bar chart shows that almost 40% respondents that choosing train and rail live in Queens, higher than the sampling proportion. So this can be treated as a significant pattern. We can see from the New York City subway system map that Queens almost has no subway system, indicating that the residents living there have limited public transportation modes choices and that what we suspected has been verified. 

```{r}
df_general["Borough"] <- as.data.frame(unlist(df_general$borough))

borough_total <- df_general[c("Borough", "allwt")] %>%
  group_by(Borough) %>%
  summarise(Count = sum(allwt)) %>%
  ungroup() %>%
  mutate(Prop = Count / sum(Count), type = "Total")

borough <- merge(travel_mode, df_general) %>%
  subset(select = c(1, 5, 39, 40)) %>%
  filter(`Train&Rail` == 1) %>%
  group_by(Borough) %>%
  summarise(Count = sum(allwt)) %>%
  ungroup() %>%
  mutate(Prop = Count/sum(Count), type = "Prefer Train & Rail")

borough <- rbind(borough_total, borough)

ggplot(borough, aes(fct_reorder(Borough, -Prop), Prop)) +
  geom_col() +
  facet_grid(.~ type) +
  labs(x = 'Borough', y = 'Proportion', title = "Borough Distribution of Residents", 
       caption = "Source: https://data.cityofnewyork.us/Transportation/Citywide-Mobility-Survey-Main-Survey/dd6w-hnq9") +
  theme_wsj() +
  theme_user(15, 14, 12, 0)
```
![](image/subway_map.png)

## Is there any differences between the age composition of the residents choosing different transportation modes?

We are concerned about the choices of middle-aged residents and old residents, so we divide the respondents into two groups, below 60 years old and above 60 years old. There are 80% middle-aged respondents and almost 20% old residents.

```{r}
age <- df_general[c(1, 3, 31)] %>%
  filter(qage != 1999)

age$Age <- cut(age$qage, breaks = c(17, 60, 100, 1999), 
               labels=c("18-59", 
                        "60-99", "Refused"))

age %>%
  group_by(Age) %>%
  summarise(num = sum(allwt)) %>%
  ungroup() %>%
  mutate(prop = num / sum(num)) %>% 
  ggplot(aes(Age, prop)) +
  geom_col() +
  labs(x = 'Age', y = 'Proportion', title = "Propotion of Respondents with Different Age", 
       caption = "Source: https://data.cityofnewyork.us/Transportation/Citywide-Mobility-Survey-Main-Survey/dd6w-hnq9") +
  theme_wsj() +
  theme_user(15, 14, 12, 0)
```

The result is consistent with what we thought. Middle-aged residents take a relative huge proportion in people who choode bicycle, while more old residents prefer taking car to get around the city due to healthy or some other issue. 

```{r}
library(ggmosaic)

age_1 <- merge(age, travel_mode) %>%
  subset(select = c(1, 4:12)) %>%
  filter(Age %in% c("60-99", "18-59"))

age_1 <- age_1 %>%
  gather(key = "Mode", value = "Count", -c(1, 2)) %>%
  merge(weight, by = "UniqueID", all.x = TRUE) %>%
  filter(!is.na(Count) & !is.na(weight_fill)) %>%
  mutate(Count = weight_fill * Count) %>%
  group_by(Mode, Age) %>%
  summarise(Sum = sum(Count)) %>%
  ungroup()

age_1$Mode <- factor(age_1$Mode, levels = c("Bicycle", "Train&Rail", "Subway", "Ferry", "For-hire vehicle", "Walk", "Bus", "Car"))
 



ggplot(age_1) +
  geom_mosaic(aes(x = product(Age, Mode), fill = Age, weight = Sum)) + 
  labs(x = 'Transportation Mode', y = 'Age', title = "Age Composition",
       caption = "Source: https://data.cityofnewyork.us/Transportation/Citywide-Mobility-Survey-Main-Survey/dd6w-hnq9") +
  scale_fill_brewer(palette = "Set2") +
  theme_wsj() +
  theme_user(16, 16, 12, 45) + 
  theme(legend.position = "none")

```

