# Results

```{r}
library(tidyverse)
library(ggthemes)
library(parcoords)
load("data/travel_data.rda")  # df_travel
load("data/mobility_general.rda")  # df_general
```

```{r someVar, echo=FALSE}
# Define a function to set the theme of plots
theme_user <- function(total_size, title_size, subtitle_size) {
  theme_plot <- theme_bw(total_size) +
  theme(axis.text.x = element_text(size = rel(0.8), angle = 45, vjust = 0.5),
        axis.text.y = element_text(size = rel(0.8)), 
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(size = rel(0.8)),
        axis.title.y = element_text(size = rel(0.8)),
        panel.grid.major.x = element_line(size = 0.8),
        panel.grid.major.y = element_line(size = 0.8),
        panel.grid.minor.x = element_blank(),
        plot.title = element_text(size = title_size), 
        plot.subtitle = element_text(color = "gray30", size = subtitle_size),
        plot.caption = element_text(size = rel(0.5)),
        legend.title = element_blank(),
        legend.text = element_text(size = 10),
        legend.key.size = unit(0.6, "cm"),
        panel.spacing = unit(.5, 'pt'))
  return <- theme_plot
}
```

## Feature of Residents Choosing Different Transportation Modes

First, we plot a parallel coordinates plot to get an idea of our dataset. The lines are colored by transportation modes. By changing the position of each categorical variable, we can notice that each of the transportation mode are composed of almost all kinds of residents and the difference may be the proportion of each kind of residents in the tranportation mode. So, we will focus on the influence of each feature on the composition of transportation modes in the following analysis.

```{r someVar, echo=FALSE}
travel_mode <- df_travel[c(1, 5:12)]
traveler <- df_general[c(1:6)]  

total <- merge(travel_mode, traveler, by = "UniqueID", all = TRUE) %>%
  filter(qgender %in% c(1, 2), qage <= 100)

total <- total %>%
  gather(key = 'Mode', value = "Number", -c(1, 10:14)) 

total <- subset(total, select = c("qgender", "qage", "qrace", "qeducation", "qincome", "Mode"))
colnames(total) <- c("Gender", "Age", "Race", "Education", "Income", "Mode")
total['Gender'] <- factor(total$Gender)

total %>% 
  parcoords(rownames = FALSE,
            brushMode = "1D-axes", 
            reorderable = TRUE,
            color = list(colorBy = "Mode",
                         colorScale = "scaleOrdinal",
                         colorScheme = "schemeCategory10"),
            withD3 = TRUE,
            alpha = 0.4)
```

We plot a stacked bar chart for each feature. First of all, we can see that gender, age and income all have influence on the composition of the transportation modes. More specifically, the majority of the residents who willing to ride a bicycle to get around the city are males, around 18-54 years old, and most of them have an income ranging from \$50,000 to \$149,999. Bus, for-hire vehicle and walk are prefered by female residents. In addition, compared with bicycle, other transportation modes are prefered by a relative high proportion of people over 55 years old. Also, a higher proportion of people whose income is higher than 150,000 love to get around the city using bicycle, car and for-hire vehicle when compared with bus, ferry and subway. The majority of residents that prefer taking train are around 25-64 years old.

```{r someVar, echo=FALSE}
# Transportation mode ~ Gender
travel_mode <- df_travel[c(1, 4:12)]
traveler_gender <- df_general[c(1:2)]  

colnames(traveler_gender) <- c('UniqueID', 'Gender')
traveler_gender['Gender'] <- factor(traveler_gender$Gender)

df1 <- merge(travel_mode, traveler_gender, by = "UniqueID", all = TRUE) %>%
  filter(Gender %in% c(1, 2))

df1 <- df1 %>%
  gather(key = 'Mode', value = "Number", -c(1:2, 11)) 

weight <- df1 %>%
  group_by(UniqueID) %>%
  summarise(Weight = sum(allwt) / (8 * sum(Number))) %>%
  ungroup()

df1 <- merge(df1, weight, by = "UniqueID", all = TRUE) %>%
  mutate(Count = Weight * Number)

ggplot(df1, aes(Mode, Count, fill = Gender)) +
  geom_bar(stat="identity", position = "fill") + 
  labs(x = 'Transportation Mode', y = 'Proportion', caption = "Source: https://data.cityofnewyork.us/Transportation/Citywide-Mobility-Survey-Main-Survey/dd6w-hnq9") +
  theme_wsj() +
  scale_fill_brewer(palette = "Set2", name = "Gender", labels = c("Male", "Female")) +
  theme_user(15, 12, 12)
```


```{r someVar, echo=FALSE}
# Transportation mode ~ Age
traveler_age <- df_general[c(1, 3)]  
df2 <- merge(travel_mode, traveler_age, by = "UniqueID", all = TRUE) %>%
  merge(weight, by = "UniqueID", all = TRUE)

df2$Age <- cut(df2$qage, breaks = c(17, 24, 54, 64, 100, 1999), 
               labels=c("18-24","25-54", 
                        "55-64", ">65", "Refused"))

df2['Age'] <- factor(df2$Age, 
                     levels = c("18-24","25-54", 
                                "55-64", ">65", "Refused"))
df2 <- df2 %>%
  gather(key = 'Mode', value = "Number", -c(1:2, 11:13)) %>%
  mutate(Count = Number * Weight)

custom.col <- c("#FFDB6D", "#C4961A", "#F4EDCA", 
                "#D16103", "#C3D7A4", "#52854C", "#4E84C4", "#293352",
                "wheat3", "wheat4", "steelblue3")

ggplot(df2, aes(Mode, Count, fill = Age)) +
  geom_bar(stat="identity", position = "fill") + 
  ylab('Proportion') + 
  labs(x = 'Transportation Mode', y = 'Proportion', caption = "Source: https://data.cityofnewyork.us/Transportation/Citywide-Mobility-Survey-Main-Survey/dd6w-hnq9") +
  scale_fill_brewer(palette = "Set2") +
  theme_user(15, 12, 12)
```


```{r someVar, echo=FALSE}
# Transportation mode ~ Income
traveler_income <- df_general[c(1, 6)] 
df4 <- merge(travel_mode, traveler_income, by = "UniqueID", all = TRUE) %>%
  merge(weight, by = "UniqueID", all = TRUE)

df4$qincome[df4$qincome %in% c(1, 2)] <- "Less than $24,999"
df4$qincome[df4$qincome %in% c(3, 4)] <- "$25,000 - $49,999"
df4$qincome[df4$qincome %in% c(5, 6)] <- "$50,000 - $99,999"
df4$qincome[df4$qincome %in% c(7)] <- "$100,000 - $149,999"
df4$qincome[df4$qincome %in% c(8, 9)] <- "$150,000 and above"
df4$qincome[df4$qincome %in% c(10, 11)] <- "Other"

df4['Income'] <- factor(df4$qincome, 
                     levels = c("Less than $24,999", "$25,000 - $49,999", "$50,000 - $99,999", 
                                "$100,000 - $149,999", "$150,000 and above", "Other"))

df4$Income[df4$Income %in% c(1, 2)] <- "Less than $24,999"
df4$Income[df4$Income %in% c(3, 4)] <- "$25,000 - $49,999"
df4$Income[df4$Income %in% c(8, 9)] <- "$150,000 and above"

df4 <- df4 %>%
  gather(key = 'Mode', value = "Number", -c(1:2, 11:13)) %>%
  mutate(Count = Weight * Number)

ggplot(df4, aes(Mode, Count, fill = Income)) +
  geom_col(position  = "fill") + 
  ylab('Proportion') + 
  labs(x = 'Transportation Mode', y = 'Proportion', caption = "Source: https://data.cityofnewyork.us/Transportation/Citywide-Mobility-Survey-Main-Survey/dd6w-hnq9") +
  scale_fill_brewer(palette = "Set2", name = "Income") +
  theme_user(15, 12, 12)
```
