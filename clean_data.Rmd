---
title: "clean_data"
author: "Chao Huang"
date: "11/21/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## data cleaning

```{r cars}
library(openxlsx)
library(dplyr)
library(tidyverse)
```

## Read data

```{r}
survey <- read.csv("./data/raw_survey_data.csv")
df_list <- list()
```

## Useful functions

```{r}
one_hot_to_factor <- function (filtered_df, 
                               encoding_dict,
                               new_name,
                               include_other=F) {
  subset <- filtered_df %>% 
  unite("collected", -UniqueID) %>% 
  mutate(list_view=str_split(collected, "_")) %>% 
  mutate(true_false=map(list_view, function(x) ifelse(x == "1", TRUE, FALSE)))

  result <- map(subset$true_false, function(x) as.vector(encoding_dict[x]))
  subset %>% mutate(result=result) %>% select(UniqueID, !!new_name := result)
}
```

```{r}
parse_column_description <- function (prefix) {
  column_info <- read.xlsx("./data/Data Dictionary.xlsx", sheet = "Column Info")
  description <- column_info$X2
  found_cols <- unlist(Filter(function (x) {startsWith(x, prefix)}, description))
  prefix_len <- str_length(prefix)
  trimmed_cols <- str_trim(substring(found_cols, first = prefix_len + 1), side = "both")
  trimmed_cols <- str_replace_all(trimmed_cols, "[?]", "")
  unlist(Filter(function (x) ! str_detect(tolower(x), tolower("Free text")), trimmed_cols))
}
```

```{r}
index_mapping <- function () {
  
}
```

## Demographic columns: 3~68

```{r}
survey_dmg <- survey %>% select(Job:qSurveyZone)
df_list[["dmg"]] <- survey_dmg
```

## Borough: 69 ~ 78

```{r}
borough_dict <- parse_column_description("Does the respondent live in")
survey_borough <- one_hot_to_factor(survey %>% select(c(UniqueID, starts_with("qborough"))), 
                                    borough_dict, 
                                    "borough")
df_list[["borough"]] <- survey_borough
```

## Travel Code (Which of the following modes of transportation do you use to get around the city?): 79 ~ 130

```{r}
travel_code_dict <- parse_column_description("Which of the following modes of transportation do you use to get around the city?")
survey_travel_code <- survey %>% select(c(UniqueID, starts_with("qusetravelcode")))
survey_travel_code <- one_hot_to_factor(survey_travel_code,
                                        travel_code_dict, 
                                        "travel_code")
df_list[["travel_code"]] <- survey_travel_code
```

## Car info: 131 ~ 147

```{r}
survey_car_info <- survey %>% select(c(UniqueID, qlicense:qcarchange))
df_list[["car_info"]] <- survey_car_info
```

## Car number decrease/increase and reasons: 148 ~ 231

```{r}
survey_car_num_change <- survey %>% select(c(UniqueID, starts_with("gCAR")))
df_list[["car_num_change"]] <- survey_car_num_change
```

## Car park: 232 ~ 248

```{r}
park_dict = parse_column_description("Where do you typically park each vehicle?")
survey_car_park <- survey %>% select(c(UniqueID, matches("qcarpark\\d+")))
survey_car_park <- one_hot_to_factor(survey_car_park, park_dict, "parking_places")
df_list[["survey_car_park"]] <- survey_car_park
```

## Car pay amount and miles: 249 ~ 261

```{r}
survey_car_price <- survey %>% select(c(UniqueID, qcarparkpay, qcarparkpay_month, qcarmiles))
df_list[["car_price"]] <- survey_car_price
```

## Car share services: 262 ~ 278

```{r}
survey_qshare <- survey %>% select(c(UniqueID, matches("qshare\\d+")))
share_dict <- parse_column_description("Which of the following car sharing services, if any, are you a member of?")
survey_qshare <- one_hot_to_factor(survey_qshare, share_dict, "share_services")
df_list[["share"]] <- survey_qshare
```

## Car share years and freqs: 279 ~ 293

```{r}
survey_share_time <- survey %>% select(c(UniqueID, qsharemember, qsharefreq))
df_list[["share_time"]] <- survey_share_time
```

## Car share purpose: 294 ~ 316

```{r}
survey_share_purp <- survey %>% select(c(UniqueID, starts_with("qsharepurpose")))

share_purp_dict <-  parse_column_description("When using a car sharing service, what are the three most common purposes of your trips?")

survey_share_purp <- one_hot_to_factor(survey_share_purp, share_purp_dict, "use_share_purpose")

df_list[["share_purp"]] <- survey_share_purp
```

## Methods prior zipcar: 317 ~ 335

```{r}
survey_prior_zip <- survey %>% select(c(UniqueID, starts_with("qziptravel")))

prior_zip_dict <- parse_column_description("How did you make those trips prior to becoming a member at Zipcar or Enterprise?")

survey_prior_zip <- one_hot_to_factor(survey_prior_zip, prior_zip_dict, "Methods prior zipcar")

df_list[["prior_zip"]] <- survey_prior_zip
```

## Methods prior ReachNow: 336 ~ 354

```{r}
survey_prior_reach <- survey %>% select(c(UniqueID, starts_with("qreachtravel")))

prior_reach_dict <- parse_column_description("How did you make those trips prior to becoming a member at Car2go or ReachNow?")

survey_prior_reach <- one_hot_to_factor(survey_prior_reach, prior_reach_dict, "Methods prior Reach")

df_list[["prior_reach"]] <- survey_prior_reach
```

## Methods prior Share car services (combined reach and zip): 355 ~ 406

```{r}
prior_share_dict <- parse_column_description("If member of a carshare company (combined Zipcar/Enterprise and car2go/ReachNow), how did you make trips prior to membership?")

survey_prior_share <- survey %>% select(c(UniqueID, matches("qsharetravelcode\\d+")))
survey_prior_share <- one_hot_to_factor(survey_prior_share, prior_share_dict, "Method prior sharing services")

df_list[["prior_share"]] <- survey_prior_share
```

## Ride-hailing apps: 407 ~ 422

```{r}
ride_hail_dict <-  c("Uber", "Lyft", "Via", "Gett", "Juno", "None of the above", "Don't know", "Refused")
survey_ride_hail <- survey %>% select(c(UniqueID, matches("qridehail\\d+")))
survey_ride_hail <- one_hot_to_factor(survey_ride_hail, ride_hail_dict, "Ride Hail Services")

df_list[["ride_hail"]] <- survey_ride_hail
```


## Ride-hailing frequency: 423 ~ 430

```{r}
survey_ride_hail_freq <- survey %>% select(c(UniqueID, qridehail_freq))

df_list[["ride_hail_freq"]] <- survey_ride_hail_freq
```

## Ride hail purpose: 431 ~ 453

```{r}
ride_hail_purp_dict <- parse_column_description("When using ride-hailing apps, what are the three most common purposes of your trips?")

survey_ride_hail_purp <- survey %>% select(c(UniqueID, starts_with("qridehailpurpose")))
survey_ride_hail_purp <- one_hot_to_factor(survey_ride_hail_purp, ride_hail_purp_dict, "Purpose of using ride hailing app")

df_list[["ride_hail_purp"]] <- survey_ride_hail_purp
```

## Prior to Ride hail: 454 ~ 501

```{r}
pre_ride_hail_dict <- parse_column_description("Before you began using ride-hailing services, how did you typically make those trips?")

survey_pre_ride_hail <- survey %>% select(c(UniqueID, starts_with("qpreridehail")))

survey_pre_ride_hail <- one_hot_to_factor(survey_pre_ride_hail, pre_ride_hail_dict, "Prior to Riding Hail")

df_list[["pre_ride_hail"]] <- survey_pre_ride_hail
```

## Trip Planning App: 502 ~ 516

```{r}
trip_planning_dict = parse_column_description("Which of the following trip planning apps, if any, do you use at least once a week?")
survey_trip_planning <- survey %>% select(c(UniqueID, starts_with("qtripplanning")))
survey_trip_planning <- one_hot_to_factor(survey_trip_planning, trip_planning_dict, "Trip Planning App")
df_list[["trip_planning"]] <- survey_trip_planning
```


## Write final dataframe

```{r}
tidy_survey <- survey %>% select(UniqueID)

for (df in df_list) {
  tidy_survey <- left_join(base, df, by = "UniqueID")
}
```

```{r}
save(tidy_survey, file="./data/tidy_survey_data_Part_1.rda")
```

## load it if needed, the df is called tidy_survey

```{r}
load("./data/tidy_survey_data_Part_1.rda")
```

